<!DOCTYPE html>  <html> <head>   <title>riak.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               riak.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This file is provided to you under the Apache License,
Version 2.0 (the "License"); you may not use this file
except in compliance with the License.  You may obtain
a copy of the License at</p>

<p>http://www.apache.org/licenses/LICENSE-2.0</p>

<p>Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This is a Javascript client for the Riak REST API. It
has two dependencies:</p>

<p>1 - Douglas Crockford's JSON library: http://www.json.org/js.html</p>

<p>2 - jQuery: http://jquery.com/ (but only for Ajax requests)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><strong>Start of Code Documentation</strong></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Utility functions which don't belong anywhere else</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">RiakUtil</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Base64 encode a number</p>

<ul>
<li><p>@param num - Number to encode</p></li>
<li><p>@return string containing base64 encoded number</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">base64Encode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">base64digits</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">base64digits</span><span class="p">[(</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">26</span><span class="p">)]</span> <span class="o">+</span> <span class="nx">base64digits</span><span class="p">[((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">)]</span> <span class="o">+</span>
               <span class="nx">base64digits</span><span class="p">[((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">)]</span> <span class="o">+</span> <span class="nx">base64digits</span><span class="p">[((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">)]</span> <span class="o">+</span>
               <span class="nx">base64digits</span><span class="p">[((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">)]</span> <span class="o">+</span> <span class="nx">base64digits</span><span class="p">[((</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;==&#39;</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Trim spaces from beginning/end of text</p>

<ul>
<li><p>@param text - Text to trimg</p></li>
<li><p>@return string with leading &amp; trailing spaces removed</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">trim</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Was request successful?</p>

<ul>
<li><p>@param req- XMLHttpRequest object</p></li>
<li><p>@return true if status is 2xx, false otherwise</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">wasSuccessful</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;</span> <span class="mi">199</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><strong>Create a modified accepts object</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">multipart_accepts</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">.</span><span class="nx">accepts</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">accepts</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">accepts</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">current</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">accepts</span><span class="p">.</span><span class="nx">multipart</span> <span class="o">=</span> <span class="s2">&quot;multipart/mixed;q=1.1&quot;</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">accepts</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">get_boundary</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">contentType</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">contentType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;boundary=&quot;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">throw</span><span class="p">(</span><span class="s1">&#39;Could not locate boundary for multipart/mixed&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">contentType</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">idx</span><span class="o">+</span><span class="mi">9</span><span class="p">);</span>
    <span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><strong><em>Parse a 300 request into siblings</em></strong></p>

<p>This handles embedded
new lines and control characters.  Unfortunately Firefox
seems to trim embedded \000 in the XHR response.  Beware
for binary data (images etc) you may need to set allow_mult
false for the bucket until an alternative is found.</p>

<ul>
<li><p>@param contentType content type header with boundary information</p></li>
<li><p>@param text body of 300 response to be split</p></li>
<li><p>@return true if status is 2xx, false otherwise</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">parseSiblings</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">contentType</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">prefixAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">===</span> <span class="nx">prefix</span><span class="p">);</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">nextChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lookFor</span><span class="p">,</span> <span class="nx">start_idx</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">lookFor</span><span class="p">,</span> <span class="nx">start_idx</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
          <span class="k">throw</span><span class="p">(</span><span class="s2">&quot;Could not find next chunk&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">idx</span><span class="p">;</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">boundary</span> <span class="o">=</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">get_boundary</span><span class="p">(</span><span class="nx">contentType</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">nextBoundary</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="o">+</span><span class="nx">boundary</span><span class="o">+</span><span class="s2">&quot;\r\n&quot;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">nextChunk</span><span class="p">(</span><span class="nx">nextBoundary</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">nextBoundary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="c1">// skip preamble</span>
      <span class="kd">var</span> <span class="nx">last_idx</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">siblings</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">sibling</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">nextBoundary</span> <span class="o">=</span> <span class="s2">&quot;\r\n--&quot;</span><span class="o">+</span><span class="nx">boundary</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>If a header</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">prefixAt</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="s2">&quot;\r\n&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">last_idx</span> <span class="o">=</span> <span class="nx">idx</span><span class="p">;</span>
          <span class="nx">idx</span> <span class="o">=</span> <span class="nx">nextChunk</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="nx">last_idx</span><span class="p">);</span>
	  <span class="kd">var</span> <span class="nx">hdr</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">last_idx</span><span class="p">,</span> <span class="nx">idx</span><span class="p">);</span>
          <span class="nx">last_idx</span> <span class="o">=</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
          <span class="nx">idx</span> <span class="o">=</span> <span class="nx">nextChunk</span><span class="p">(</span><span class="s2">&quot;\r\n&quot;</span><span class="p">,</span> <span class="nx">last_idx</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">last_idx</span><span class="p">,</span> <span class="nx">idx</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">hdr</span> <span class="o">===</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sibling</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">hdr</span> <span class="o">===</span> <span class="s1">&#39;Link&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sibling</span><span class="p">.</span><span class="nx">linkHeader</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">idx</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>          
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Idx points to \r\n at end of headers, grab the body</span>
          <span class="nx">last_idx</span> <span class="o">=</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
          <span class="nx">idx</span> <span class="o">=</span> <span class="nx">nextChunk</span><span class="p">(</span><span class="nx">nextBoundary</span><span class="p">,</span> <span class="nx">last_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nx">sibling</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">last_idx</span><span class="p">,</span> <span class="nx">idx</span><span class="p">);</span>
          <span class="nx">siblings</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sibling</span><span class="p">);</span>
          <span class="nx">sibling</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="nx">idx</span> <span class="o">+=</span> <span class="nx">nextBoundary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">prefixAt</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="s2">&quot;--\r\n&quot;</span><span class="p">))</span> <span class="c1">// --boundary-- is the end of </span>
            <span class="k">break</span><span class="p">;</span> 
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">prefixAt</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="s2">&quot;\r\n&quot;</span><span class="p">))</span>
            <span class="nx">idx</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">else</span>
            <span class="k">throw</span><span class="p">(</span><span class="s2">&quot;Expecting boundary or end of multipart/mixed&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">siblings</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}();</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><strong><em>Builds a map/reduce chain and executes it</em></strong></p>

<ul>
<li><p>@param client RiakClient object</p></li>
<li><p>@param bucketName Riak bucket name</p></li>
<li><p>@param key Riak bucket key (optional)</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">RiakMapper</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">bucketName</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">bucketName</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span>
      <span class="nx">client</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span><span class="p">(</span><span class="s1">&#39;Cannot construct RiakMapper without bucketName and client&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="nx">client</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">bucket</span> <span class="o">=</span> <span class="nx">bucketName</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">phases</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><strong><em>Add a map phase to a map/reduce job</em></strong> </p>

<ul>
<li><p>@param options - Hash describing the map phase</p></li>
<li><p>@return RiakMapper instance for method chaining fun</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakMapper</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">phases</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_buildPhase</span><span class="p">({</span><span class="nx">map</span><span class="o">:</span> <span class="kc">null</span><span class="p">},</span> <span class="nx">options</span><span class="p">));</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><strong><em>Add a map phase to a map/reduce job</em></strong></p>

<ul>
<li><p>@param options - Hash describing the reduce phase</p></li>
<li><p>@return RiakMapper instance for method chaining fun</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakMapper</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">phases</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_buildPhase</span><span class="p">({</span><span class="nx">reduce</span><span class="o">:</span> <span class="kc">null</span><span class="p">},</span> <span class="nx">options</span><span class="p">));</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><strong><em>Add a link phase to a map/reduce job</em></strong></p>

<p>@param options - Hash describing the link phase</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakMapper</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">link</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">phases</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_buildPhase</span><span class="p">({</span><span class="nx">link</span><span class="o">:</span> <span class="kc">null</span><span class="p">},</span> <span class="nx">options</span><span class="p">));</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p><strong><em>Runs a map/reduce job</em></strong></p>

<ul>
<li><p>@param timeout - Job timeout (in milliseconds). Defaults to 60000</p></li>
<li><p>@param callback - Function to call when op completes</p></li>
<li><p>callback - function(success, request, results)</p></li>
<li><p>@param success - Boolean indicating success or failure</p></li>
<li><p>@param results - JSON decoded results or null</p></li>
<li><p>@param request - XMLHttpRequest object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakMapper</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeout</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">timeout</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">timeout</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">timeout</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">timeout</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">timeout</span><span class="p">;</span>
    <span class="nx">timeout</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">mapper</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">job</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inputs&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_buildInputs</span><span class="p">(),</span>
	     <span class="s1">&#39;query&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">phases</span><span class="p">,</span>
	     <span class="s1">&#39;timeout&#39;</span><span class="o">:</span> <span class="nx">timeout</span><span class="p">};</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">mapredUrl</span><span class="p">,</span>
	       <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
	       <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">job</span><span class="p">),</span>
	       <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-ClientId&#39;</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">clientId</span><span class="p">);</span> <span class="p">},</span>
	       <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">StatusText</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
						       <span class="k">if</span> <span class="p">(</span><span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">wasSuccessful</span><span class="p">(</span><span class="nx">req</span><span class="p">))</span> <span class="p">{</span>
							 <span class="nx">callback</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">),</span> <span class="nx">req</span><span class="p">);</span>
						       <span class="p">}</span>
						       <span class="k">else</span> <span class="p">{</span>
							 <span class="k">try</span> <span class="p">{</span>
							   <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="p">{</span><span class="nx">error</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)};</span>
							   <span class="nx">callback</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
							 <span class="p">}</span>
							 <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
							   <span class="nx">callback</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
							 <span class="p">}</span>
						       <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p><strong>Start RiakMapper internals</strong> </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakMapper</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_buildPhase</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">starter</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">source</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">source</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
      <span class="k">try</span>
      <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p><strong><em>Create a string with minimal padding</em></strong></p>

<p>JSON.parse
does not like embedded newlines in strings
and function.toString() on FireFox (on 3.6.3) generates
a string with embedded newlines.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">options</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">((</span><span class="nx">starter</span><span class="p">.</span><span class="nx">map</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span>
       <span class="nx">starter</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">language</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">language</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">language</span> <span class="o">=</span> <span class="s1">&#39;javascript&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">starter</span><span class="p">.</span><span class="nx">map</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">starter</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">starter</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">===</span> <span class="kc">null</span><span class="p">){</span>
    <span class="nx">starter</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">bucket</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">bucket</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">bucket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bucketName</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">starter</span><span class="p">.</span><span class="nx">link</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">starter</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">RiakMapper</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_buildInputs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[[</span><span class="k">this</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">]];</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bucket</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><em>End RiakMapper internals</em></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><strong><em>Models an entry in a Riak bucket</em></strong> </p>

<ul>
<li><p>@param bucketName - Riak bucket name</p></li>
<li><p>@param key - Object's key</p></li>
<li><p>@param client - Owning RiakClient</p></li>
<li><p>@param body - Object's data</p></li>
<li><p>@param contentType - Mime type associated with data</p></li>
<li><p>@param vclock - Riak-assigned vclock</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">RiakObject</span><span class="p">(</span><span class="nx">bucketName</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">contentType</span><span class="p">,</span> <span class="nx">vclock</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">client</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span><span class="p">(</span><span class="s2">&quot;Cannot construct RiakObject without a client reference&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">bucket</span> <span class="o">=</span> <span class="nx">bucketName</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="nx">client</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">contentType</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">=</span> <span class="s1">&#39;application/octet-stream&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">=</span> <span class="nx">contentType</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">contentType</span> <span class="o">===</span> <span class="s1">&#39;application/json&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">body</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">vclock</span> <span class="o">=</span> <span class="nx">vclock</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">links</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p><strong><em>'Hydrates' a RiakObject from a HTTP request</em></strong></p>

<ul>
<li><p>@param bucket - Riak bucket name</p></li>
<li><p>@param key - Riak bucket key</p></li>
<li><p>@param client - Owning RiakClient</p></li>
<li><p>@param req - XMLHttpRequest</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">fromRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">contentType</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">vclock</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-Vclock&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">linkHeader</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s1">&#39;Link&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">retval</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RiakObject</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">contentType</span><span class="p">,</span> <span class="nx">vclock</span><span class="p">);</span>
  <span class="nx">retval</span><span class="p">.</span><span class="nx">setLinks</span><span class="p">(</span><span class="nx">linkHeader</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">retval</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">RiakObject</span><span class="p">.</span><span class="nx">fromMultipart</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">vclock</span><span class="p">,</span> <span class="nx">multipartChunk</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">retval</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RiakObject</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">multipartChunk</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span> <span class="nx">multipartChunk</span><span class="p">.</span><span class="nx">contentType</span><span class="p">,</span> <span class="nx">vclock</span><span class="p">);</span>
  <span class="nx">retval</span><span class="p">.</span><span class="nx">setLinks</span><span class="p">(</span><span class="nx">multipartChunk</span><span class="p">.</span><span class="nx">linkHeader</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">retval</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p><strong><em>Begins building a map/reduce job which will use the current object as input</em></strong></p>

<ul>
<li>@param options - Hash description the map phase</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RiakMapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">mapper</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><strong><em>Begins building a map/reduce job which will use the current object as input</em></strong></p>

<ul>
<li>@param options - Hash description the reduce phase</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RiakMapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">mapper</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p><strong><em>Begins building a map/reduce job which will use the current object as input</em></strong></p>

<ul>
<li>@param options - Hash description the link phase</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">link</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RiakMapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">mapper</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p><strong><em>Parses a raw link header and populates the links array</em></strong></p>

<ul>
<li>@param linkHeader - Raw link header string</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setLinks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">linkHeader</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">parsedLinks</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">linkHeader</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">links</span> <span class="o">=</span> <span class="nx">linkHeader</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">linkParts</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">linkTag</span> <span class="o">=</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">linkParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="kd">var</span> <span class="nx">linkTo</span> <span class="o">=</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">linkParts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/Link: ?/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
      <span class="nx">linkTo</span> <span class="o">=</span> <span class="nx">linkTo</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="nx">linkTo</span> <span class="o">=</span> <span class="nx">linkTo</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\&quot;/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="nx">linkTag</span> <span class="o">=</span> <span class="nx">linkTag</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;riaktag=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="nx">linkTag</span> <span class="o">=</span> <span class="nx">linkTag</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\&quot;/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="nx">parsedLinks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">tag</span><span class="o">:</span> <span class="nx">linkTag</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">target</span><span class="o">:</span> <span class="nx">linkTo</span><span class="p">.</span><span class="nx">toString</span><span class="p">()});</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">links</span> <span class="o">=</span> <span class="nx">parsedLinks</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p><strong><em>Retrieves the links collection</em></strong></p>

<ul>
<li>@return Array of link hashes (e.g. [{tag: 'userInfo', target: '/riak/users/bob'}])</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getLinks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p><strong><em>Returns the links formatted for the Link header</em></strong></p>

<ul>
<li>@return - Link header string</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getLinkHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">header</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">link</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">header</span> <span class="o">=</span> <span class="nx">header</span> <span class="o">+</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">link</span><span class="p">.</span><span class="nx">target</span> <span class="o">+</span> <span class="s1">&#39;&gt;; &#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">link</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;rel=up&#39;</span><span class="p">)</span> <span class="p">{</span>
	  <span class="nx">header</span> <span class="o">=</span> <span class="nx">header</span> <span class="o">+</span> <span class="s1">&#39;rel=&quot;up&quot;, &#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
	  <span class="nx">header</span> <span class="o">=</span> <span class="nx">header</span> <span class="o">+</span> <span class="s1">&#39;riaktag=\&quot;&#39;</span> <span class="o">+</span> <span class="nx">link</span><span class="p">.</span><span class="nx">tag</span> <span class="o">+</span> <span class="s1">&#39;\&quot;, &#39;</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">header</span> <span class="o">=</span> <span class="nx">header</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\&quot;\&quot;/g</span><span class="p">,</span> <span class="s1">&#39;\&quot;&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">header</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/,\s$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p><strong><em>Adds a link to the object's link collection</em></strong></p>

<ul>
<li><p>@param link - Pointer to other object (e.g. /riak/foo/bar)</p></li>
<li><p>@param tag - Tag for the link (e.g. 'userInfo')</p></li>
<li><p>@param noDuplicates - Toggle duplicate checking on/off</p></li>
<li><p>@return true if added, false otherwise</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addLink</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">link</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">noDuplicates</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">link</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span><span class="p">(</span><span class="s1">&#39;Invalid link: &#39;</span> <span class="o">+</span> <span class="nx">link</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">retval</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">noDuplicates</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">||</span> <span class="nx">noDuplicates</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">tag</span><span class="o">:</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">target</span><span class="o">:</span><span class="nx">link</span><span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">foundDuplicate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">foundDuplicate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">tag</span> <span class="o">===</span> <span class="nx">tag</span> <span class="o">&amp;&amp;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">target</span> <span class="o">===</span> <span class="nx">link</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">foundDuplicate</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">retval</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">foundDuplicate</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">tag</span><span class="o">:</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">target</span><span class="o">:</span> <span class="nx">link</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">retval</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><strong><em>Removes a link from the links collection based on link and tag</em></strong></p>

<ul>
<li><p>@param link - Pointer to other object</p></li>
<li><p>@param tag - Tag for the link</p></li>
<li><p>@return true if link removed, false if not</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeLink</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">link</span><span class="p">,</span> <span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">retval</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">newLinks</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">link</span> <span class="o">!==</span> <span class="nx">link</span> <span class="o">||</span> <span class="nx">l</span><span class="p">.</span><span class="nx">tag</span> <span class="o">!==</span> <span class="nx">tag</span><span class="p">;</span> <span class="p">});</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">newLinkes</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="k">this</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">retval</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">links</span> <span class="o">=</span> <span class="nx">newLinks</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">retval</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p><strong><em>Resets the links collection to an empty array</em></strong></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clearLinks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">links</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p><strong><em>Deletes an object from a Riak bucket</em></strong>
@param callback - Function to call when op complete</p>

<ul>
<li><p>callback - function(success, request)</p></li>
<li><p>@param success - Boolean flag indicating successful removal</p></li>
<li><p>@param request - XMLHTTPRequest object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">_buildPath</span><span class="p">(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span>
	       <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span>
               <span class="nx">accepts</span><span class="o">:</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">multipart_accepts</span><span class="p">(),</span>
               <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;multipart&#39;</span><span class="p">,</span>
	       <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-ClientId&#39;</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">clientId</span><span class="p">);</span>
					   <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">vclock</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">vclock</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
					     <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-Vclock&#39;</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">vclock</span><span class="p">);</span>
					   <span class="p">}</span>
					 <span class="p">},</span>
	       <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
						      <span class="k">if</span> <span class="p">(</span><span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">wasSuccessful</span><span class="p">(</span><span class="nx">req</span><span class="p">))</span> <span class="p">{</span>
							<span class="nx">callback</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
						       <span class="p">}</span>
						       <span class="k">else</span> <span class="p">{</span>
							 <span class="nx">callback</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
						       <span class="p">}</span>
						     <span class="p">}</span> <span class="p">}});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p><strong><em>Store the object in Riak</em></strong></p>

<ul>
<li><p>@param callback - Function to call when op completes</p></li>
<li><p>callback - function(status, object, request);</p></li>
<li><p>@param status - 'status' of the result: 'ok', 'failed', or 'siblings'</p></li>
<li><p>@param object - If status is 'ok', object is an updated RiakObject instance</p></li>
</ul>

<p>If status is 'siblings', object is an array of RiakObject instances 
which the client can pick from to resolve the conflict. If status is 'failed', object is null</p>

<p>NOTE: Use the updated version to prevent siblings &amp; vector clock explosion</p>

<ul>
<li>@param request - XMLHttpRequest object</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span><span class="p">(</span><span class="s1">&#39;RiakObject missing contentType&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">objectData</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">===</span> <span class="s1">&#39;application/json&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">objectData</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">objectData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">objectData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">_buildPath</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span>
	  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span>
	  <span class="nx">data</span><span class="o">:</span> <span class="nx">objectData</span><span class="p">,</span>
	  <span class="nx">contentType</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">contentType</span><span class="p">,</span>
          <span class="nx">accepts</span><span class="o">:</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">multipart_accepts</span><span class="p">(),</span>
          <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;multipart&#39;</span><span class="p">,</span>
	  <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-ClientId&#39;</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">clientId</span><span class="p">);</span>
				      <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">vclock</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">vclock</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-Vclock&#39;</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">vclock</span><span class="p">);</span>
				      <span class="p">}</span>
				      <span class="kd">var</span> <span class="nx">linkHeader</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">getLinkHeader</span><span class="p">();</span>
				      <span class="k">if</span> <span class="p">(</span><span class="nx">linkHeader</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Link&#39;</span><span class="p">,</span> <span class="nx">linkHeader</span><span class="p">);</span>
				      <span class="p">}</span>
				    <span class="p">},</span>
	  <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">)</span> <span class="p">{</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_store</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span> <span class="p">}</span> <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Start RiakObject Internals </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakObject</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_store</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">204</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="nx">RiakObject</span><span class="p">.</span><span class="nx">fromRequest</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="nx">req</span><span class="p">),</span> <span class="nx">req</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* Uh-oh, we&#39;ve got siblings! */</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">300</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">siblingData</span> <span class="o">=</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">parseSiblings</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">),</span>
					       <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">vclock</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-Vclock&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">thisObject</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">siblings</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">siblingData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sd</span> <span class="o">=</span> <span class="nx">siblingData</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">sib</span> <span class="o">=</span> <span class="nx">RiakObject</span><span class="p">.</span><span class="nx">fromMultipart</span><span class="p">(</span><span class="nx">thisObject</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> 
                                           <span class="nx">thisObject</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="nx">vclock</span><span class="p">,</span> <span class="nx">sd</span><span class="p">);</span>
        <span class="nx">siblings</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sib</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;siblings&#39;</span><span class="p">,</span> <span class="nx">siblings</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p><em>End RiakObject Internals</em></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p><strong><em>Models a Riak bucket</em></strong></p>

<ul>
<li><p>@param bucket - Riak bucket name</p></li>
<li><p>@param client - RiakClient reference</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">RiakBucket</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">client</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span><span class="p">(</span><span class="s2">&quot;Cannot construct RiakBucket without client reference&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">bucket</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="nx">client</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">props</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p><strong><em>"Hydrates" a RiakBucket from a HTTP request</em></strong></p>

<ul>
<li><p>@param bucketName - Riak bucket name (duh!)</p></li>
<li><p>@param client - RiakClient object</p></li>
<li><p>@param req - Active XMLHttpRequest object</p></li>
<li><p>@return populated RiakBucket instance</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">fromRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bucketName</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">RiakBucket</span><span class="p">(</span><span class="nx">bucketName</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p><strong><em>Begins building a map/reduce job which will use the entire bucket contents as input</em></strong></p>

<ul>
<li><p>@param options - Hash description the map phase</p></li>
<li><p>@return RiakMapper object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RiakMapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">mapper</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p><strong><em>Begins building a map/reduce job which will use the entire bucket contents as input</em></strong></p>

<ul>
<li><p>@param options - Hash description the reduce phase</p></li>
<li><p>@return RiakMapper object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RiakMapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">mapper</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p><strong><em>Begins building a map/reduce job which will use the entire bucket contents as input</em></strong></p>

<ul>
<li><p>@param options - Hash description the link phase</p></li>
<li><p>@return RiakMapper object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">link</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RiakMapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">bucket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">mapper</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p><strong><em>Sets/gets the nValue for this bucket</em></strong></p>

<ul>
<li><p>@param n -- New nValue (optional)</p></li>
<li><p>@return the current nValue</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">nValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">retval</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">n_val</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">n_val</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
    <span class="nx">retval</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">retval</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p><strong><em>Enables/disables multiple bucket entries</em></strong></p>

<ul>
<li><p>@param flag -- true or false</p></li>
<li><p>@return the current setting</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">allowsMultiples</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">flag</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">retval</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">allow_mult</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">flag</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">allow_mult</span> <span class="o">=</span> <span class="nx">flag</span><span class="p">;</span>
    <span class="nx">retval</span> <span class="o">=</span> <span class="nx">flag</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">retval</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p><strong><em>Stores bucket</em></strong></p>

<ul>
<li><p>@param callback - Function to call when op has completed</p></li>
<li><p>callback - function(bucket, request)</p></li>
<li><p>@param bucket - Updated bucket or null if store failed</p></li>
<li><p>@param request - XMLHTTPRequest object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bucket</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">currentProps</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">currentProps</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">_buildPath</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
	  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span>
	  <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">currentProps</span><span class="p">),</span>
	  <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
	  <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
	  <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span> 
              <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-ClientId&#39;</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">clientId</span><span class="p">);</span>
          <span class="p">},</span>
	  <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">)</span> <span class="p">{</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">_store</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span> <span class="p">}</span> <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p><strong><em>Fetch an entry from the bucket</em></strong></p>

<ul>
<li><p>@param key - Riak bucket key</p></li>
<li><p>@param callback - Function to call when op has completed</p></li>
<li><p>callback - function(object, request)</p></li>
<li><p>@param object - RiakObject if found, otherwise null</p></li>
<li><p>@param request - XMLHTTPRequest object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bucket</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">_buildPath</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">key</span><span class="p">),</span>
	  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
          <span class="nx">accepts</span><span class="o">:</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">multipart_accepts</span><span class="p">(),</span>
          <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;multipart&#39;</span><span class="p">,</span>
	  <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-ClientId&#39;</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">clientId</span><span class="p">);</span>
          <span class="p">},</span>
	  <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">)</span> <span class="p">{</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">_handleGetObject</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> <span class="p">}</span> <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>**_Fetch an entry from the bucket or create a new oneif not found//</p>

<ul>
<li><p>@param key - Riak bucket key</p></li>
<li><p>@param callback - Function to call when op has completed</p></li>
<li><p>callback - function(object, request)</p></li>
<li><p>@param object - RiakObject instance</p></li>
<li><p>@param request - XMLHTTPRequest object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get_or_new</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bucket</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">_buildPath</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">key</span><span class="p">),</span>
	  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
          <span class="nx">accepts</span><span class="o">:</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">multipart_accepts</span><span class="p">(),</span>
          <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;multipart&#39;</span><span class="p">,</span>
	  <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-ClientId&#39;</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">clientId</span><span class="p">);</span>
          <span class="p">},</span>
	  <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">)</span> <span class="p">{</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">_handleGetObject</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="p">}</span> <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p><strong><em>Deletes an object from a Riak bucket</em></strong> </p>

<ul>
<li><p>@param key - Riak bucket key</p></li>
<li><p>@param callback - Function to call when op complete</p></li>
<li><p>callback - function(success, request)</p></li>
<li><p>@param success - Boolean flag indicating successful removal</p></li>
<li><p>@param request - XMLHTTPRequest object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>	
<span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bucket</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">_buildPath</span><span class="p">(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">key</span><span class="p">),</span>
	       <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span>
               <span class="nx">accepts</span><span class="o">:</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">multipart_accepts</span><span class="p">(),</span>
               <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;multipart&#39;</span><span class="p">,</span>
	       <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-ClientId&#39;</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">clientId</span><span class="p">);</span>
					   <span class="k">if</span> <span class="p">(</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">vclock</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">vclock</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
					     <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-Vclock&#39;</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">vclock</span><span class="p">);</span>
					   <span class="p">}</span>
					 <span class="p">},</span>
	       <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
						      <span class="k">if</span> <span class="p">(</span><span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">wasSuccessful</span><span class="p">(</span><span class="nx">req</span><span class="p">))</span> <span class="p">{</span>
							<span class="nx">callback</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
						       <span class="p">}</span>
						       <span class="k">else</span> <span class="p">{</span>
							 <span class="nx">callback</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
						       <span class="p">}</span>
						     <span class="p">}</span> <span class="p">}});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p><strong>Start RiakBucket internals</strong></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_store</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">204</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">bucket</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_handleGetObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">createEmpty</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;ok&#39;</span><span class="p">;</span>
      <span class="nx">object</span> <span class="o">=</span> <span class="nx">RiakObject</span><span class="p">.</span><span class="nx">fromRequest</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">createEmpty</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;ok&#39;</span><span class="p">;</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RiakObject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">);</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>must not create empty return failed/null</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Uh-oh, we've got siblings! </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">300</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">siblingData</span> <span class="o">=</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">parseSiblings</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">),</span>
					       <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">vclock</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-Vclock&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">thisBucket</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">siblings</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">siblingData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sd</span> <span class="o">=</span> <span class="nx">siblingData</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">sib</span> <span class="o">=</span> <span class="nx">RiakObject</span><span class="p">.</span><span class="nx">fromMultipart</span><span class="p">(</span><span class="nx">thisBucket</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> 
                                           <span class="nx">thisBucket</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="nx">vclock</span><span class="p">,</span> <span class="nx">sd</span><span class="p">);</span>
        <span class="nx">siblings</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sib</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;siblings&#39;</span>
      <span class="nx">object</span> <span class="o">=</span> <span class="nx">siblings</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">status</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p><em>End RiakBucket internals</em></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p><strong><em>Entry point for interacting with Riak</em></strong></p>

<ul>
<li><p>@param baseUrl - URL for 'raw' interface (optional, default: '/riak')</p></li>
<li><p>@param mapredUrl - URL for map/reduce jobs (optional, default: '/mapred')</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">RiakClient</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="nx">mapredUrl</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">baseUrl</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">&#39;/riak/&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">baseUrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">baseUrl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">baseUrl</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">baseUrl</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">=</span> <span class="nx">baseUrl</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">clientId</span> <span class="o">=</span> <span class="s2">&quot;js_&quot;</span> <span class="o">+</span> <span class="nx">RiakUtil</span><span class="p">.</span><span class="nx">base64Encode</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">4294967296</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">mapredUrl</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mapredUrl</span> <span class="o">=</span> <span class="nx">mapredUrl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mapredUrl</span> <span class="o">=</span> <span class="s1">&#39;/mapred&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p><strong><em>Fetches a bucket from Riak</em></strong></p>

<p>Buckets <em>always</em> exist so no need to handle</p>

<ul>
<li><p>@param bucket Riak bucket name</p></li>
<li><p>@param callback Function to call when op completes</p></li>
<li><p>callback - function(bucket, request)</p></li>
<li><p>@param bucket - RiakBucket instance</p></li>
<li><p>@param request - XMLHTTPRequest object</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bucket</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_buildPath</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">),</span>
	  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
	  <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
	  <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
	  <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span> 
              <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Riak-ClientId&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">clientId</span><span class="p">);</span>
          <span class="p">},</span>
	  <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">)</span> <span class="p">{</span> <span class="nx">client</span><span class="p">.</span><span class="nx">_handleGetBucket</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> <span class="p">}</span> <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>**Start of the RiakClient internal functions </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RiakClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_handleGetBucket</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bucketName</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">createEmpty</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bucket</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">RiakBucket</span><span class="p">.</span><span class="nx">fromRequest</span><span class="p">(</span><span class="nx">bucketName</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">RiakClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_buildPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">+</span> <span class="nx">bucket</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Reluctantly adding a cache breaker to each request.  FireFox
sometimes caches XHR responses which triggers failures in the
unit tests (and presumably real code).  See 'bypassing the cache'
in https://developer-stage.mozilla.org/En/Using_XMLHttpRequest</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">cache_breaker</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">4294967296</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="nx">cache_breaker</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;PUT&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;&amp;returnbody=true&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="nx">cache_breaker</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;&amp;keys=false&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p><em>*End RiakClient internal Functions *</em></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html>